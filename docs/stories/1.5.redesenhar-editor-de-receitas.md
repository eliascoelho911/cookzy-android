# Story 1.5: Redesenhar Editor de Receitas (protótipo Compose)

## Status
Done

## Story
**Como** usuário do Cookzy,
**eu quero** um Editor com layout em cards, validações claras e ações consistentes,
**para** criar/editar receitas com rapidez e menos fricção.

## Acceptance Criteria
1. App Bar com voltar e ação de salvar (✔). Salvar habilita somente com: Título preenchido + ≥ 1 ingrediente + ≥ 1 passo.
2. Layout em cards: “Cabeçalho”, “Ingredientes” e “Instruções”. Cards “Ingredientes” e “Instruções” suportam adicionar/remover e reordenar via alça “≡”.
3. Validações inline e feedback por Snackbar para erros gerais; ao salvar com sucesso, navegar para o Detalhe da Receita.
4. Fora do escopo do Épico 01: Stepper de Porções, Card “Nutrição”, “Livros de Receitas” e “Link de origem” (não exibir no MVP deste épico; podem ser placeholders comentados/ocultos).
5. Persistência: manter o modelo atual (ingredientes com `rawText` apenas; sem unidade persistida). Reordenar e remoções respeitam o mínimo exigido.

## Dependencies
- DS (Story 1.7): Reuso/expansão do módulo `ds` existente. Componentes já disponíveis: `AppTopBar`, `IconToggle`, `InformationalStates`, `RecipeCard`, `RecentCarousel`.
- DS (Story 1.8): Componentes do editor a serem criados — `docs/stories/1.8.ds-componentes-editor.md`.
- Inventário de componentes: `docs/architecture/components-inventory.md` – entradas relevantes: `ReorderableList`, `IngredientRow`, `TabsRecipeDetail`, `EmptyState`/`ErrorState`.
- Iconografia: `ds/src/main/java/com/eliascoelho911/cookzy/ds/icons/IconRegistry.kt` — adicionar `DragHandle`.

## Tasks / Subtasks
- [x] UI — Reestruturar para cards e implementar reordenação (drag handle) em Ingredientes/Instruções (AC: 2)
- [x] UI — App Bar + ação de salvar com gating por requisitos mínimos (AC: 1)
- [x] UI — Mensagens de validação inline e Snackbar (AC: 3)
- [x] Ocultar/adiar itens fora do escopo (Porções, Nutrição, Livros, Link de origem) (AC: 4)
- [x] A11y — Foco consistente, rotulagem de controles, alvos ≥ 48dp (AC: 1–4)
- [x] DS — Criar `FormSectionCard`, `EditorTextField`/`EditorMultilineField`, `ReorderableList`, `IngredientEditorRow`, `InstructionEditorRow` (com alça `DragHandle`)
- [x] Strings — Adicionar chaves de validação/erros/ações no `strings.xml`

## Dev Notes
- Arquitetura/UI: docs/ui-architecture.md (gestão de estado, padrões de lista dinâmica, previews).
- Manter compatibilidade com Story 1.1 (modelo `rawText` e navegação salvar→Detalhe; cancelar→voltar).
- Componentes Design System a criar (módulo `ds`):
  - `FormSectionCard`: contêiner padrão para seções do editor (Cabeçalho/Ingredientes/Instruções) com título, descrição opcional e slots para ações (`Adicionar`, `Remover tudo`) e conteúdo.
  - `EditorTextField` (single-line) e `EditorMultilineField`: campos de texto DS com suporte a rótulo, placeholder, contador e mensagem de erro inline (`supportingText`) que será consumida na validação de título/ingredientes/instruções.
  - `ReorderableList` + `ReorderableListItem`: abstração genérica para listas reordenáveis com alça “≡”, animações de arraste e callbacks `onMove`, evitando lógica ad-hoc na tela.
  - `IngredientEditorRow`: item reutilizável com `EditorTextField`, alça de reordenação e ação de remoção (`IconRegistry.Delete`); expõe `value`, `error`, `onValueChange`, `onRemove`.
  - `InstructionEditorRow`: variação multiline com contagem de passo opcional, alça de reordenação e ações de remoção/duplicação quando aplicável.
- Iconografia: adicionar `IconRegistry.DragHandle` (`Icons.Outlined.DragHandle`) para a alça de reordenação.

### UX/A11y (ux-expert)
- Drag & drop: alça com alvo ≥ 48dp; leitura por leitor de tela “Reordenar item X. Arraste para mover.”
- Erros inline: associar `supportingText` ao campo via `semantics { error(message) }`; Snackbar com ação “Ok” e `liveRegion` para anúncio.
- Foco: ao inserir novo item, focar o campo recém-criado; após remover, mover foco para o item anterior.
- Ações: rótulos consistentes para “Adicionar ingrediente”/“Adicionar passo”; `contentDescription` na alça e no botão remover.

### Cenários de Validação (po/pm)
- Título obrigatório (trim); 1+ ingrediente não vazio; 1+ passo não vazio.
- Linhas vazias não contam para o mínimo e exibem erro inline “Campo obrigatório”.
- Reordenação não deve permitir lista vazia quando restar apenas 1 item; remoção do último deve estar bloqueada com dica.
- Duplicados permitidos no MVP (sem dedupe automático). Trim aplicado em salvar.
- Erros gerais (ex.: falha de persistência): Snackbar com mensagem padrão e retry quando aplicável.

### Sequenciamento & Responsabilidades (sm)
- DS entrega primeiro: `FormSectionCard`, campos de texto, `ReorderableList`, `IngredientEditorRow`, `InstructionEditorRow`, `DragHandle`.
- Feature (Editor) integra componentes DS, implementa validações e navegação.
- QA define e executa testes Compose e valida gating do salvar.

### Riscos & Rollback (qa/architect)
- Risco de regressão ao substituir o editor atual: manter “feature flag”/rota antiga até validação.
- Rollback: reverter navegação para a tela antiga do editor; preservar modelo de dados (sem migrações).
- Monitorar crashes de tela do editor e taxa de sucesso no salvar (se telemetria disponível).

### Strings sugeridas (pm)
- `editor_title_hint`, `editor_title_error_required`
- `editor_ingredients_title`, `editor_ingredients_add`, `editor_ingredients_error_required`
- `editor_instructions_title`, `editor_instructions_add`, `editor_instructions_error_required`
- `editor_snackbar_save_error`, `editor_snackbar_save_success`

### Testing
- Testes unitários para validações e lógica de salvamento.

## Change Log
| Date       | Version | Description                        | Author |
|------------|---------|------------------------------------|--------|
| 2025-10-23 | 0.1     | Rascunho inicial (redesign Editor) | PM     |

## Dev Agent Record

### Agent Model Used

- Codex (GPT-5)

### Debug Log References

- ./gradlew :app:testDebugUnitTest --tests com.eliascoelho911.cookzy.feature.recipeeditor.RecipeEditorViewModelTest

### Completion Notes List

- Reestruturei o editor com `FormSectionCard`, campos DS e listas reordenáveis, incluindo foco automático ao adicionar/remover itens e ação de salvar na App Bar com `state.canSave`.
- Atualizei o ViewModel para validação completa (título, ingredientes, passos), movimentos de itens, foco dirigido e mensagens de bloqueio ao remover o último item.
- Adicionei novas strings, previews de estados de erro, ajustei `IconRegistry.DragHandle` para o ícone Material e atualizei o teste unitário; verificação com `./gradlew :app:testDebugUnitTest --tests com.eliascoelho911.cookzy.feature.recipeeditor.RecipeEditorViewModelTest`.
- Posicionei os botões “Adicionar ingrediente/passo” após as listas, ocultando-os quando o último item está vazio; Enter cria um novo campo quando o cursor está no último item ou apenas avança o foco para o próximo quando estiver em qualquer outro.
- Expandi a suíte de testes unitários do ViewModel para cobrir adição/remoção/reordenação de itens, foco consumido e falhas de persistência, garantindo regressões mínimas com `RecipeEditorViewModelTest`.

### File List

- app/src/main/java/com/eliascoelho911/cookzy/feature/recipeeditor/RecipeEditorViewModel.kt
- app/src/main/java/com/eliascoelho911/cookzy/feature/recipeeditor/RecipeEditorScreen.kt
- app/src/main/java/com/eliascoelho911/cookzy/feature/recipeeditor/PreviewData.kt
- app/src/main/res/values/strings.xml
- app/src/test/java/com/eliascoelho911/cookzy/feature/recipeeditor/RecipeEditorViewModelTest.kt
- ds/src/main/java/com/eliascoelho911/cookzy/ds/icons/IconRegistry.kt

## QA Results
