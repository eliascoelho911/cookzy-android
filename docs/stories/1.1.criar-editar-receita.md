# Story 1.1: Criar/Editar Receita (campos essenciais)

## Status
Ready for QA

## Story
**Como** usuário do Cookzy,
**eu quero** criar e editar uma receita com campos essenciais (título, ingredientes, preparo),
**para** manter meu acervo organizado e pronto para uso no preparo.

## Acceptance Criteria
1. Editor simplificado: título (obrigatório), ingredientes como lista de linhas de texto (um por item) e preparo em um único campo multilinha.
2. Validações: título é obrigatório com feedback acessível; salvar permitido independentemente do formato dos ingredientes.
3. Persistência: ao salvar, cada ingrediente armazena apenas `rawText` exatamente como digitado (ordem preservada); não há `name`, `quantity` ou `unit` persistidos.
4. Quantidade derivada: a quantidade do ingrediente é inferida a partir de `rawText` quando possível e recalculada sempre que requisitada (não persistida).
5. Navegação: após salvar, ir para o Detalhe da Receita; cancelar volta sem salvar.

## Tasks / Subtasks
- [x] Data Model (Room) (AC: 3)
  - [x] Atualizar `IngredientEntity` para conter apenas `id`, `recipeId`, `rawText` (e `position` se necessário).
  - [x] Remover `name/quantity/unit` de todas as camadas (entity, DTO, domain). Usar `fallbackToDestructiveMigration()` (app ainda não produtivo).
- [x] DAO/Repository (AC: 3)
  - [x] Ajustar DAOs e repositório para o novo esquema minimalista baseado em `rawText`.
  - [x] Remover mapeamentos/acessos a campos antigos.
- [x] Derivação de Quantidade (AC: 4)
  - [x] Implementar utilitário puro `deriveQuantity(rawText: String): BigDecimal?` (ou equivalente) sem persistência.
  - [x] Recalcular on-demand ao fornecer dados para UI/uso de domínio; retorno nulo quando não inferível.
- [x] UI — Editor (AC: 1, 2)
  - [x] Ingredientes: trocar para lista de linhas de texto (um campo por item); remover campo de observações.
  - [x] Preparo: gerenciar passos individuais com campos dedicados (adicionar/remover, multiline).
  - [x] Manter validação de título e mensagens de erro acessíveis.
- [x] UI — Detalhe (AC: 5)
  - [x] Exibir ingredientes a partir de `rawText` por linha com destaque na quantidade inferida.
  - [x] Listar passos do preparo individualmente.
- [x] Navegação (AC: 5)
  - [x] Manter fluxo salvar→Detalhe; cancelar→voltar.
- [x] Testes (AC: 2, 3, 4, 5)
  - [x] DAO: validar persistência apenas de `rawText` e ordem.
  - [x] Utilitário de derivação: cobrir casos representativos e ambiguidades.
  - [x] ViewModel: validação de título e integração com derivação on-demand.
  - [x] Fluxo: verificação de navegação em salvar/cancelar.

## Dev Notes
- Persistência local: Room/SQLite. `Ingredient` deve persistir apenas `rawText` (texto integral digitado). Unidades não são armazenadas.
- Derivação de quantidade: função pura e não persistida; recalcular sempre que requisitado pela UI/camada de domínio.
- UI/Estado: Compose + ViewModel, com contratos de Estado/Evento/Efeito (docs/front-end/03-arquitetura-componentes.md). Editor com lista de linhas para ingredientes e lista dinâmica de passos de preparo.
- DI: manter Koin atualizado para repos/VMs impactados.

### Especificação de Derivação de Quantidade (MVP)

- Casos suportados
  - Inteiros: extrair o primeiro número inteiro.
    - Exemplos: "2", "2 ovos", "02 tomates" → 2
  - Decimais (vírgula ou ponto): normalizar vírgula para ponto.
    - Exemplos: "0,5 xícara", "1.25 kg", "1,0 unidade" → 0.5, 1.25, 1.0
  - Frações simples (a/b): denominadores comuns 2, 3, 4, 8.
    - Exemplos: "1/2 cebola", "3/4 copo", "2/3 xícara", "1/8 colher" → 0.5, 0.75, 0.666…, 0.125
  - Frações unicode: ½ ¼ ¾ ⅓ ⅔ ⅛.
    - Exemplos: "½ xícara", "1¾ copo" → 0.5, 1.75
  - Números mistos (inteiro + fração): com espaço entre inteiro e fração.
    - Exemplos: "1 1/2 xícara", "2 ¼ xícara" → 1.5, 2.25
  - Unidades e texto periférico: ignorados para extração do número.
    - Exemplos: "aprox. 2 xícaras", "~0,5 kg", "1/2kg" → 2, 0.5, 0.5
  - Sinais e formatação tolerada: espaços extras, maiúsculas/minúsculas, texto antes/depois.

- Casos ambíguos → retornar null
  - Intervalos ou múltiplos valores: "1-2", "1 a 2", "2–3", "0,5 a 1", "1/4–1/2".
  - Multiplicadores com dois números: "2 x 200 g", "3×250 ml".
  - Listas numéricas: "1, 2, 3 ovos".
  - Texto sem dígitos: "a gosto", "pitada", "um punhado" (fase futura pode incluir "um/uma/dois/duas/meia").
  - Formatos inválidos: "1/0", "3," (vírgula/ponto soltos).

- Normalização e política numérica
  - Locale: aceitar vírgula e ponto; converter para ponto internamente.
  - Frações: converter para decimal; para casos não exatos (ex.: 1/3), usar BigDecimal com escala 3 (0.333) e sem arredondar para inteiro.
  - Saída: BigDecimal não-negativo; remover zeros à direita conforme preferência da camada chamadora.
  - Primeira ocorrência: em strings com vários tokens, considerar o primeiro padrão suportado; se houver segundo número, classificar como ambíguo e retornar null.

- Exemplos rápidos
  - "2 ovos" → 2
  - "0,75 xícara" → 0.75
  - "½ colher" → 0.5
  - "1 ¼ xícara" → 1.25
  - "2/3 xícara de açúcar" → 0.666
  - "aprox. 3 tomates" → 3
  - "1-2 colheres" → null
  - "2 x 200 g" → null
  - "a gosto" → null

- Escopo desta história
  - Persistência: somente `rawText` (sem `quantity/unit`) em `Ingredient`.
  - Derivação: on-demand pela função `deriveQuantity(rawText: String): QuantityDerivationResult?` (valor + intervalo da substring) para consumo pela UI.

#### Ready for Dev (Checklist)
- [x] Habilitar `fallbackToDestructiveMigration()` no builder do Room.
- [x] Remover referências a `name/quantity/unit` de entity/DTO/domain/DAO/Repo.
- [x] Introduzir utilitário `deriveQuantity(rawText: String)` sem persistência.
- [x] Atualizar Editor/Detalhe para consumir apenas `rawText` e derivação on-demand.
- [x] Atualizar módulos do Koin para quaisquer novos provedores/VMs afetados.

### Testing
- DAO: garantir persistência apenas de `rawText` e ordem estável de ingredientes.
- Derivação: testes unitários para `deriveQuantity` cobrindo formatos comuns e casos ambíguos.
- ViewModel/UI: validação de título obrigatório, gestão dinâmica de ingredientes e passos, e fluxo salvar/cancelar.

#### AC → Validação
- AC1 (Editor simplificado): teste de UI/Compose verificando presença dos campos (título, lista de ingredientes por linha, passos de preparo individuais) e interação básica.
- AC2 (Validações): unit test do ViewModel para obrigatoriedade do título e exibição de mensagem de erro acessível.
- AC3 (Persistência rawText): teste de DAO garantindo somente `rawText` salvo e ordem preservada; confirmar ausência de `name/quantity/unit` no schema.
- AC4 (Quantidade derivada on-demand): testes unitários do utilitário confirmando cálculo quando possível e `null` quando ambíguo; confirmar que nada é persistido.
- AC4 (Quantidade derivada on-demand): testes unitários do utilitário confirmando cálculo quando possível e `null` quando ambíguo; confirmar que nada é persistido e que o intervalo retornado corresponde à substring destacada.
- AC5 (Navegação): teste de navegação/Compose verificando salvar→Detalhe e cancelar→voltar.

## Change Log
| Date       | Version | Description                               | Author |
|------------|---------|-------------------------------------------|--------|
| 2025-10-22 | 0.6     | Derivação trata quantidades coladas na unidade (300g, 0,5kg, 1/2kg) com testes atualizados | Dev |
| 2025-10-21 | 0.5     | Ingredientes migrados para rawText com derivação on-demand, passos individuais e destaque da quantidade na UI | Dev |
| 2025-10-21 | 0.4     | Ajuste de requisitos: ingredientes como rawText, remoção de unit/name/quantity do modelo/DAO; quantidade derivada on-demand (não persistida); editor simplificado | PM     |
| 2025-10-20 | 0.3     | Migração para Koin, BaseViewModel comum e testes Mockk | Dev    |
| 2025-10-20 | 0.2     | Implementação do CRUD local e telas de criação/detalhe | Dev    |
| 2025-10-20 | 0.1     | Rascunho inicial da história               | PM     |

## Dev Agent Record

### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- 2025-10-21: `./gradlew test`
- 2025-10-22: `./gradlew testDebugUnitTest --tests com.eliascoelho911.cookzy.domain.util.QuantityDerivationTest`

### Completion Notes List
- Persistência local criada com Room (entidades, DAO, migração 0→1 e repositório offline) para receitas com ingredientes e passos.
- Arquitetura Compose agora conduzida por Koin (módulos de database, repositório e ViewModels) e BaseViewModel genérico para unificar gestão de estado/efeitos.
- ViewModels refatorados para uso de Koin + BaseViewModel; tela principal e fluxo editor/detalhe usam `koinViewModel` nas rotas de navegação.
- Testes unitários atualizados para usar Mockk na simulação de dependências; `./gradlew test` executado com sucesso.
- Atualização para ingredientes baseados em `rawText`, utilitário de derivação `deriveQuantity`, editor com gerenciamento individual de passos e detalhe destacando a quantidade inferida diretamente no texto do ingrediente.
- Derivação de quantidade agora reconhece valores colados às unidades (300g, 0,5kg, 1/2kg) com cobertura de testes dedicada.

### File List
- gradle/libs.versions.toml
- app/build.gradle.kts
- app/src/main/AndroidManifest.xml
- app/src/main/java/com/eliascoelho911/cookzy/android/CookzyApplication.kt
- app/src/main/java/com/eliascoelho911/cookzy/android/MainActivity.kt
- app/src/main/java/com/eliascoelho911/cookzy/core/BaseViewModel.kt
- app/src/main/java/com/eliascoelho911/cookzy/di/AppModules.kt
- app/src/main/java/com/eliascoelho911/cookzy/ui/CookzyApp.kt
- app/src/main/java/com/eliascoelho911/cookzy/ui/CookzyNavHost.kt
- app/src/main/java/com/eliascoelho911/cookzy/data/local/database/CookzyDatabase.kt
- app/src/main/java/com/eliascoelho911/cookzy/data/local/entity/IngredientEntity.kt
- app/src/main/java/com/eliascoelho911/cookzy/data/repository/OfflineRecipeRepository.kt
- app/src/main/java/com/eliascoelho911/cookzy/feature/recipeeditor/RecipeEditorViewModel.kt
- app/src/main/java/com/eliascoelho911/cookzy/feature/recipeeditor/RecipeEditorScreen.kt
- app/src/main/java/com/eliascoelho911/cookzy/feature/recipedetail/RecipeDetailViewModel.kt
- app/src/main/java/com/eliascoelho911/cookzy/feature/recipedetail/RecipeDetailScreen.kt
- app/src/main/java/com/eliascoelho911/cookzy/domain/util/QuantityDerivation.kt
- app/src/main/java/com/eliascoelho911/cookzy/domain/model/RecipeIngredient.kt
- app/src/main/java/com/eliascoelho911/cookzy/feature/recipelist/RecipeListViewModel.kt
- app/src/main/java/com/eliascoelho911/cookzy/feature/recipelist/RecipeListScreen.kt
- app/src/test/java/com/eliascoelho911/cookzy/data/local/dao/RecipeDaoTest.kt
- app/src/test/java/com/eliascoelho911/cookzy/feature/recipeeditor/RecipeEditorViewModelTest.kt
- app/src/test/java/com/eliascoelho911/cookzy/domain/util/QuantityDerivationTest.kt

## QA Results
