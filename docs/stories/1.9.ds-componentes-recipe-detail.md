# Story 1.9: Design System — Componentes para RecipeDetail (Épico 01)

## Status
Ready

## Story
Como equipe de desenvolvimento do Cookzy,
eu quero componentes reutilizáveis no Design System para a tela de Detalhe da Receita,
para padronizar o redesign da Story 1.6 com acessibilidade, consistência visual e maior velocidade de implementação.

## Acceptance Criteria
1. App Bar e Hero:
   - `RecipeAppBarActions` entrega clusters leading (Close/Back) e trailing (Share/Edit/Favorite) com botões circulares ≥48dp, ícones do `IconRegistry` e API que aceita lista de ações (ícone + descrição + callback).
   - `RecipeHero` suporta imagem opcional, overlay Play, subtítulo, timer (`IconRegistry.Timer`) e gradiente para legibilidade. Props: `title`, `subtitle`, `timeMinutes`, `image`, `videoAvailable`, `onPlay`.
   - `VideoBadge`/`SourceBadge` (YouTube) exibe ícone + label conforme layout (ver `codex-clipboard-XDXpBX.png`) e aceita qualquer provider.
2. Resumo nutricional e CTA:
   - `NutritionSummaryCard` (ícone + label + valor + unidade + cor). Deve suportar `null` e estado de loading.
   - `NutritionSummaryGrid` organiza 2x2 cards responsivo, com spacing conforme mock e API para lista dinâmica.
   - `RecipePrimaryCTA` estiliza botão cheio “Iniciar Preparo” com ícone opcional, estados Enabled/Disabled/Loading e largura máxima definida pelo layout.
3. Ações rápidas:
   - `PortionStepper` (label + valor + callbacks `onIncrement`/`onDecrement`, limites configuráveis, feedback háptico opcional).
   - `MeasurementQuickAction` (pill secundária com ícone de balança, estados Enabled/Disabled/Loading).
4. Tabs e listas:
   - `RecipeTabs` (pills arredondadas) reutiliza API genérica `Tabs`, mas com skin default do layout (indicador, tipografia, estados hover/foco). Suporta badges numéricos.
   - `IngredientRow` atualizada aceita `name`, `highlighted: AnnotatedString?`, `checked` e `onCheckedChange` (para carrinho). Destaque visual para números via `SpanStyle`.
   - `IngredientListHeader` (label + count + ação secundária) e `AddToCartButton` (full-width com ícone).
5. Instruções interativas:
   - `InstructionRow` passa a aceitar `prefixContent` para chips inline e `inlineContent` para destaques.
   - `InstructionChip` (tempo/temperatura) com variações `Time`, `Temperature`, `Custom`.
   - `IngredientReferenceTooltip` mostra highlight + tooltip com descrição (setas e pointer conforme layout) e announce-friendly (`Semantics`).
6. Nutrição detalhada:
   - `NutritionDetailsCard` reusa base do summary, porém com metadata expandida (ex.: %VD).
   - `NutritionPlaceholder` mantém layout do mock com ícone ilustrativo e mensagem.
7. APIs devem ser stateless, receber `Modifier` e fontes de dados externas (nenhum acesso a `ViewModel`). Não dependem de navigation.
8. Acessibilidade: todos os componentes têm alvos ≥48dp, `contentDescription`, role=Tab/Tooltip, estados `selected/disabled` expostos e suporte a `fontScale ≥ 2.0`.
9. Previews: light/dark + `fontScale≈2.0` para cada componente, cobrindo combinações (com/sem vídeo, cards vazios, stepper limites, tooltip aberto).
10. Testes Compose: smoke + interação essencial (cliques nos ícones do App Bar, stepper limites, tabs, highlight de ingredientes, tooltip). Mínimo 1 teste por componente visível.
11. Iconografia e tokens: ícones exclusivamente via `IconRegistry`; cores/spacing com tokens DS (`CookzyTheme`). Nenhum valor mágico inline.

### UI Parity vs Mock (design/recipe-detail/img.png)
- Componentes precisam reproduzir: App Bar flutuante (dois botões leading + três trailing), hero com overlay Play e badge YouTube, cartões de macros 2x2, botão “Iniciar Preparo”, Stepper de Porções, botão “Medidas”, tabs em pill, lista de ingredientes com cabeçalho/checkbox/CTA, chips de tempo/temperatura nas instruções, tooltip/balloon para referências de ingredientes e placeholder ilustrado de nutrição.
- Ajustes aceitáveis: alterar copy/ícones contanto que venham do `IconRegistry`; grid pode quebrar em 1 coluna em telas pequenas; tooltip pode posicionar em cima/baixo conforme espaço.
- Fora do escopo: animações complexas de partículas, Prep Bar persistente, componentes de reviews/ratings e qualquer ação de marketplace externo.

## Dependencies
- Layout de referência: `design/recipe-detail/img.png` (handoff de design).
- Story 1.6 (consumidora): `docs/stories/1.6.redesenhar-detalhe-da-receita.md`.
- PRD Detalhe: `docs/prd.md:72,111-130` (CTA de vídeo, macros, carrinho, quick actions).
- Arquitetura/Standards: `docs/architecture.md`, `docs/architecture/coding-standards.md`.

## Tasks / Subtasks
- [ ] DS — RecipeAppBarActions + VideoBadge (clusters configuráveis + badge YouTube)
- [ ] DS — RecipeHero (overlay Play, timer, subtítulo, gradiente)
- [ ] DS — NutritionSummaryCard + Grid (4 cartões, estados loading/null)
- [ ] DS — RecipePrimaryCTA (botão cheio com ícone opcional)
- [ ] DS — PortionStepper (mín/máx, feedback visual) e MeasurementQuickAction
- [ ] DS — RecipeTabs (pills) com suporte a badges
- [ ] DS — IngredientRow + IngredientListHeader + AddToCartButton (destaque de quantidades + ação)
- [ ] DS — InstructionRow + InstructionChip + IngredientReferenceTooltip
- [ ] DS — NutritionDetailsCard + NutritionPlaceholder
- [ ] DS — Testes Compose + Previews cobrindo todos os componentes e estados
- [ ] Handoff — snippets de uso para integração na Story 1.6

## Dev Notes
- Referências cruzadas:
  - Story 1.6 (Detalhe): `docs/stories/1.6.redesenhar-detalhe-da-receita.md`
  - Layout: `design/recipe-detail/img.png` (ver handoff de design)
  - Arquitetura/Standards: `docs/architecture.md` e `docs/architecture/coding-standards.md`
- Componentes ficam no módulo `ds`, dentro de `ds.recipe.detail`. Reutilizam `CookzyTheme` para cores, spacing e tipografia.
- Assinaturas sugeridas:
  - `data class RecipeAction(val icon: ImageVector, val contentDescription: String, val onClick: () -> Unit)`
  - `@Composable fun RecipeAppBarActions(leading: List<RecipeAction>, trailing: List<RecipeAction>, modifier: Modifier = Modifier)`
  - `@Composable fun RecipeHero(title: String, subtitle: String?, timeMinutes: Int?, image: Painter?, videoAvailable: Boolean, onPlay: () -> Unit, modifier: Modifier = Modifier)`
  - `@Composable fun VideoBadge(providerIcon: ImageVector, label: String, modifier: Modifier = Modifier)`
  - `data class NutritionStat(val label: String, val value: String?, val unit: String?, val icon: ImageVector)`
  - `@Composable fun NutritionSummaryGrid(stats: List<NutritionStat>, modifier: Modifier = Modifier)`
  - `@Composable fun RecipePrimaryCTA(text: String, icon: ImageVector?, onClick: () -> Unit, enabled: Boolean, loading: Boolean, modifier: Modifier = Modifier)`
  - `@Composable fun PortionStepper(label: String, value: Int, onIncrement: () -> Unit, onDecrement: () -> Unit, range: IntRange, modifier: Modifier = Modifier)`
  - `@Composable fun MeasurementQuickAction(text: String, icon: ImageVector, onClick: () -> Unit, enabled: Boolean, modifier: Modifier = Modifier)`
  - `data class RecipeTabItem(val label: String, val icon: ImageVector? = null, val badge: Int? = null)`
  - `@Composable fun RecipeTabs(items: List<RecipeTabItem>, selectedIndex: Int, onSelect: (Int) -> Unit, modifier: Modifier = Modifier)`
  - `@Composable fun IngredientRow(rawText: String, highlighted: AnnotatedString?, checked: Boolean, onCheckedChange: (Boolean) -> Unit, modifier: Modifier = Modifier)`
  - `@Composable fun IngredientListHeader(title: String, count: Int, action: @Composable (() -> Unit)?, modifier: Modifier = Modifier)`
  - `@Composable fun InstructionRow(index: Int, text: AnnotatedString, prefixContent: @Composable (() -> Unit)? = null, inlineContent: Map<String, InlineTextContent> = emptyMap(), modifier: Modifier = Modifier)`
  - `enum class InstructionChipType { Time, Temperature, Custom }`
  - `@Composable fun InstructionChip(type: InstructionChipType, text: String, modifier: Modifier = Modifier)`
  - `@Composable fun IngredientReferenceTooltip(text: String, onDismiss: () -> Unit, modifier: Modifier = Modifier)`
  - `@Composable fun NutritionDetailsCard(stat: NutritionStat, modifier: Modifier = Modifier)`
  - `@Composable fun NutritionPlaceholder(modifier: Modifier = Modifier)`
- Quantidade/destaque: a heurística recomendada (detectar números/frações + unidades comuns) continua válida. Quando o app não fornecer `AnnotatedString`, `IngredientRow` deve derivar `SpanStyle(fontWeight = Bold)` automaticamente.
- Tooltip: usar `PlainTooltipBox` + `Semantics { liveRegion = Polite }` para leitura imediata. Fornecer API para alinhamento (start/end) igual ao mock.
- Strings/Ícones: DS aceita `String`/`AnnotatedString`, porém origem deve ser `strings.xml`. Ícones apenas via `IconRegistry`.
- Previews: usar `@Preview` com `uiMode` night/notnight e `fontScale = 2f`. Simular loading com `PlaceholderHighlight.fade()`.

### Handoff — snippets de uso (Story 1.6)
```kotlin
@Composable
fun RecipeDetailHeroSection(
  state: RecipeDetailState,
  onBack: () -> Unit,
  onClose: () -> Unit,
  onShare: () -> Unit,
  onFavorite: () -> Unit,
  onEdit: () -> Unit
) {
  RecipeAppBarActions(
    leading = listOf(
      RecipeAction(IconRegistry.Close, stringResource(R.string.cd_close), onClose),
      RecipeAction(IconRegistry.Back, stringResource(R.string.cd_back), onBack)
    ),
    trailing = listOf(
      RecipeAction(IconRegistry.Share, stringResource(R.string.cd_share), onShare),
      RecipeAction(IconRegistry.Edit, stringResource(R.string.cd_edit), onEdit),
      RecipeAction(IconRegistry.Favorite, stringResource(R.string.cd_favorite), onFavorite)
    )
  )
  RecipeHero(
    title = state.title,
    subtitle = state.subtitle,
    timeMinutes = state.timeMinutes,
    image = state.imagePainter,
    videoAvailable = state.hasVideo,
    onPlay = state.onPlayVideo
  )
  if (state.hasVideo) {
    VideoBadge(
      providerIcon = IconRegistry.Youtube,
      label = stringResource(R.string.recipe_detail_youtube_label)
    )
  }
}

@Composable
fun RecipeDetailSummary(state: RecipeDetailState) {
  NutritionSummaryGrid(stats = state.summaryStats)
  RecipePrimaryCTA(
    text = stringResource(R.string.recipe_detail_start_cta),
    icon = IconRegistry.Play,
    onClick = state.onStartCooking,
    enabled = state.hasInstructions,
    loading = state.isStarting
  )
  PortionStepper(
    label = stringResource(R.string.recipe_detail_servings),
    value = state.servings,
    onIncrement = state.onIncreaseServings,
    onDecrement = state.onDecreaseServings,
    range = 1..10
  )
  MeasurementQuickAction(
    text = stringResource(R.string.recipe_detail_measurements),
    icon = IconRegistry.Scale,
    onClick = state.onOpenMeasurements,
    enabled = state.measurementsAvailable
  )
}

@Composable
fun RecipeDetailTabs(selected: Int, onSelect: (Int) -> Unit) {
  val items = listOf(
    RecipeTabItem(stringResource(R.string.recipe_detail_tab_ingredients)),
    RecipeTabItem(stringResource(R.string.recipe_detail_tab_instructions)),
    RecipeTabItem(stringResource(R.string.recipe_detail_tab_nutrition))
  )
  RecipeTabs(items = items, selectedIndex = selected, onSelect = onSelect)
}

@Composable
fun IngredientSection(state: IngredientUiState) {
  IngredientListHeader(
    title = stringResource(R.string.recipe_detail_ingredients_title),
    count = state.count,
    action = {
      TextButton(onClick = state.onAddToCart) {
        Text(stringResource(R.string.recipe_detail_add_to_cart))
      }
    }
  )
  LazyColumn {
    items(state.items) { item ->
      IngredientRow(
        rawText = item.rawText,
        highlighted = item.highlighted,
        checked = item.inCart,
        onCheckedChange = { checked -> state.onIngredientToggle(item.id, checked) }
      )
    }
  }
  AddToCartButton(
    text = stringResource(R.string.recipe_detail_add_to_cart),
    icon = IconRegistry.Cart,
    onClick = state.onAddToCart,
    enabled = state.items.isNotEmpty()
  )
}

@Composable
fun InstructionSection(state: InstructionUiState) {
  LazyColumn {
    itemsIndexed(state.steps) { index, step ->
      InstructionRow(
        index = index + 1,
        text = step.annotated,
        prefixContent = {
          step.chip?.let { InstructionChip(type = it.type, text = it.text) }
        },
        inlineContent = step.inlineContent
      )
      if (step.tooltip != null && step.tooltip.visible) {
        IngredientReferenceTooltip(
          text = step.tooltip.text,
          onDismiss = step.tooltip.onDismiss
        )
      }
    }
  }
}
```

## Change Log
| Date       | Version | Description                            | Author |
|------------|---------|----------------------------------------|--------|
| 2025-11-03 | 0.2     | Alinhado ao layout (AppBar, cards, CTA, stepper, chips, tooltip) | PO     |
| 2025-11-03 | 0.1     | Rascunho inicial (DS RecipeDetail)     | PO     |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
Gate: TBD (story expandida para cobrir layout completo; aguardar novo review QA)
Reviewer: Quinn (Test Architect) — avaliação anterior restrita ao TitleBlock
Updated: 2025-11-03
Summary: A ampliação adiciona App Bar actions, cards, CTA, stepper e tooltip; nenhum teste cobre os novos componentes ainda. QA precisa validar APIs, acessibilidade e coverage antes do desenvolvimento.
Top Issues:
- high — Falta suite Compose/UI garantindo chips, tooltip e stepper.
- medium — Necessário checklist de iconografia para clusters leading/trailing.
Evidence: Layout codex-clipboard-XDXpBX, Story 1.6 atualizada e dependências de arquitetura.
Gate File: docs/qa/gates/1.9-ds-componentes-recipe-detail.yml (gerar após review)
